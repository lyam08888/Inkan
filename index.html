<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Serveur Dofus Shivas - Mode Hors Ligne</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            border: 1px solid rgba(255, 255, 255, 0.18);
            text-align: center;
            max-width: 800px;
            width: 95%;
        }

        h1 {
            font-size: 2.5em;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .logo {
            font-size: 4em;
            margin-bottom: 20px;
        }

        .description {
            font-size: 1.2em;
            margin-bottom: 30px;
            line-height: 1.6;
            opacity: 0.9;
        }

        .server-info {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            text-align: left;
        }

        .server-info h3 {
            color: #ffd700;
            margin-bottom: 10px;
        }

        .server-info p {
            margin: 5px 0;
            font-family: 'Courier New', monospace;
        }

        .button-container {
            margin: 30px 0;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
        }

        .play-button {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            border: none;
            color: white;
            padding: 15px 40px;
            font-size: 1.3em;
            font-weight: bold;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px 0 rgba(255, 107, 107, 0.4);
            margin: 10px;
        }

        .play-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px 0 rgba(255, 107, 107, 0.6);
        }

        .play-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .server-button {
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
            border: none;
            color: white;
            padding: 12px 30px;
            font-size: 1.1em;
            font-weight: bold;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px 0 rgba(78, 205, 196, 0.4);
            margin: 10px;
        }

        .server-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px 0 rgba(78, 205, 196, 0.6);
        }

        .server-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .setup-button {
            background: linear-gradient(45deg, #9b59b6, #8e44ad);
            border: none;
            color: white;
            padding: 12px 30px;
            font-size: 1.1em;
            font-weight: bold;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px 0 rgba(155, 89, 182, 0.4);
            margin: 10px;
        }

        .setup-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px 0 rgba(155, 89, 182, 0.6);
        }

        .status {
            margin: 20px 0;
            padding: 15px;
            border-radius: 10px;
            font-weight: bold;
        }

        .status.offline {
            background: rgba(255, 107, 107, 0.2);
            border: 1px solid #ff6b6b;
        }

        .status.online {
            background: rgba(78, 205, 196, 0.2);
            border: 1px solid #4ecdc4;
        }

        .status.starting {
            background: rgba(255, 193, 7, 0.2);
            border: 1px solid #ffc107;
        }

        .console {
            background: rgba(0, 0, 0, 0.7);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            text-align: left;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            max-height: 300px;
            overflow-y: auto;
            display: none;
        }

        .console.show {
            display: block;
        }

        .console-line {
            margin: 5px 0;
            padding: 2px 0;
        }

        .console-line.info {
            color: #4ecdc4;
        }

        .console-line.error {
            color: #ff6b6b;
        }

        .console-line.warning {
            color: #ffc107;
        }

        .console-line.success {
            color: #2ecc71;
        }

        .instructions {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            text-align: left;
        }

        .instructions h3 {
            color: #ffd700;
            margin-bottom: 15px;
        }

        .instructions ol {
            margin-left: 20px;
        }

        .instructions li {
            margin: 10px 0;
            line-height: 1.5;
        }

        .warning {
            background: rgba(255, 193, 7, 0.2);
            border: 1px solid #ffc107;
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
        }

        .warning h4 {
            color: #ffc107;
            margin-bottom: 10px;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
            width: 0%;
            transition: width 0.3s ease;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .spin {
            animation: spin 1s linear infinite;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            margin: 15% auto;
            padding: 20px;
            border-radius: 20px;
            width: 80%;
            max-width: 500px;
            color: white;
            text-align: center;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo">‚öîÔ∏è</div>
        <h1>Serveur Dofus Shivas</h1>
        <p class="description">
            Jouez √† Dofus en mode hors ligne avec votre serveur priv√© local !
            <br>Installation et configuration automatiques.
        </p>

        <div class="status offline" id="serverStatus">
            üî¥ Serveur arr√™t√©
        </div>

        <div class="progress-bar" id="progressBar" style="display: none;">
            <div class="progress-fill" id="progressFill"></div>
        </div>

        <div class="button-container">
            <button class="setup-button" onclick="setupEnvironment()" id="setupBtn">
                ‚öôÔ∏è Configuration automatique
            </button>
            <button class="server-button" onclick="startServer()" id="startBtn" disabled>
                üöÄ D√©marrer le serveur
            </button>
            <button class="server-button" onclick="stopServer()" id="stopBtn" style="display: none;">
                üõë Arr√™ter le serveur
            </button>
        </div>

        <div class="button-container">
            <button class="play-button pulse" onclick="playGame()" id="playBtn" disabled>
                üéÆ JOUER SANS CONNEXION
            </button>
            <button class="setup-button" onclick="downloadConfig()" id="configBtn">
                üì• T√©l√©charger config.xml
            </button>
        </div>

        <div class="console" id="console">
            <div id="consoleContent"></div>
        </div>

        <div class="server-info">
            <h3>üìã Informations de connexion</h3>
            <p><strong>Serveur de connexion :</strong> 127.0.0.1:6789</p>
            <p><strong>Serveur de jeu :</strong> 127.0.0.1:9876</p>
            <p><strong>Version client :</strong> 1.29.1</p>
            <p><strong>Base de donn√©es :</strong> MariaDB locale</p>
        </div>

        <div class="instructions">
            <h3>üìñ Instructions rapides</h3>
            <ol>
                <li><strong>Configuration :</strong> Cliquez sur "Configuration automatique" pour installer les d√©pendances</li>
                <li><strong>D√©marrage :</strong> Cliquez sur "D√©marrer le serveur" une fois la configuration termin√©e</li>
                <li><strong>Client :</strong> T√©l√©chargez le config.xml et placez-le dans votre dossier client Dofus</li>
                <li><strong>Connexion :</strong> Lancez Dofus, s√©lectionnez "localhost" et connectez-vous</li>
                <li><strong>Jouer :</strong> Cr√©ez votre personnage et amusez-vous !</li>
            </ol>
        </div>

        <div class="server-info">
            <h3>üéØ Caract√©ristiques du serveur</h3>
            <p><strong>Niveau de d√©part :</strong> 200</p>
            <p><strong>Kamas de d√©part :</strong> 1,000,000</p>
            <p><strong>Points d'action :</strong> 6</p>
            <p><strong>Points de mouvement :</strong> 3</p>
            <p><strong>Tous les waypoints :</strong> Activ√©s</p>
        </div>
    </div>

    <!-- Modal pour les messages -->
    <div id="messageModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <div id="modalContent"></div>
        </div>
    </div>

    <script>
        let serverProcess = null;
        let isServerRunning = false;
        let isSetupComplete = false;

        // Fonctions utilitaires
        function addConsoleLog(message, type = 'info') {
            const console = document.getElementById('consoleContent');
            const line = document.createElement('div');
            line.className = `console-line ${type}`;
            line.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            console.appendChild(line);
            
            // Auto-scroll vers le bas
            const consoleDiv = document.getElementById('console');
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
            
            // Afficher la console si elle est cach√©e
            consoleDiv.classList.add('show');
        }

        function updateProgress(percentage) {
            const progressBar = document.getElementById('progressBar');
            const progressFill = document.getElementById('progressFill');
            
            if (percentage > 0) {
                progressBar.style.display = 'block';
                progressFill.style.width = percentage + '%';
            } else {
                progressBar.style.display = 'none';
            }
        }

        function showModal(title, content) {
            const modal = document.getElementById('messageModal');
            const modalContent = document.getElementById('modalContent');
            modalContent.innerHTML = `<h3>${title}</h3><p>${content}</p>`;
            modal.style.display = 'block';
        }

        function closeModal() {
            document.getElementById('messageModal').style.display = 'none';
        }

        function updateServerStatus(status) {
            const statusElement = document.getElementById('serverStatus');
            const playBtn = document.getElementById('playBtn');
            const startBtn = document.getElementById('startBtn');
            const stopBtn = document.getElementById('stopBtn');

            switch(status) {
                case 'online':
                    statusElement.className = 'status online';
                    statusElement.innerHTML = 'üü¢ Serveur en ligne';
                    playBtn.disabled = false;
                    playBtn.classList.add('pulse');
                    startBtn.style.display = 'none';
                    stopBtn.style.display = 'inline-block';
                    isServerRunning = true;
                    break;
                case 'starting':
                    statusElement.className = 'status starting';
                    statusElement.innerHTML = 'üü° D√©marrage en cours...';
                    playBtn.disabled = true;
                    playBtn.classList.remove('pulse');
                    startBtn.style.display = 'none';
                    stopBtn.style.display = 'inline-block';
                    break;
                case 'offline':
                default:
                    statusElement.className = 'status offline';
                    statusElement.innerHTML = 'üî¥ Serveur arr√™t√©';
                    playBtn.disabled = true;
                    playBtn.classList.remove('pulse');
                    startBtn.style.display = 'inline-block';
                    stopBtn.style.display = 'none';
                    isServerRunning = false;
                    break;
            }
        }

        // Configuration automatique de l'environnement
        async function setupEnvironment() {
            const setupBtn = document.getElementById('setupBtn');
            const startBtn = document.getElementById('startBtn');
            
            setupBtn.disabled = true;
            setupBtn.innerHTML = '‚è≥ Configuration en cours...';
            
            addConsoleLog('D√©but de la configuration automatique...', 'info');
            updateProgress(10);

            try {
                const response = await fetch('/api/setup', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();
                
                if (result.success) {
                    // Analyser la sortie pour afficher les √©tapes
                    const lines = result.output.split('\n');
                    let progress = 20;
                    
                    for (const line of lines) {
                        if (line.trim()) {
                            const cleanLine = line.replace(/\[\d{2}:\d{2}:\d{2}\]\s*/, '');
                            if (cleanLine.includes('SUCCESS')) {
                                addConsoleLog(cleanLine, 'success');
                            } else if (cleanLine.includes('ERROR')) {
                                addConsoleLog(cleanLine, 'error');
                            } else if (cleanLine.includes('WARNING')) {
                                addConsoleLog(cleanLine, 'warning');
                            } else {
                                addConsoleLog(cleanLine, 'info');
                            }
                            
                            progress = Math.min(progress + 10, 90);
                            updateProgress(progress);
                            await simulateDelay(100);
                        }
                    }

                    updateProgress(100);
                    addConsoleLog('Configuration termin√©e avec succ√®s !', 'success');
                    isSetupComplete = true;
                    startBtn.disabled = false;
                    setupBtn.innerHTML = '‚úÖ Configuration termin√©e';
                    
                    showModal('Configuration termin√©e !', 'Votre serveur Dofus Shivas est maintenant pr√™t √† √™tre d√©marr√©. Cliquez sur "D√©marrer le serveur" pour commencer.');
                } else {
                    throw new Error(result.output || 'Configuration failed');
                }
                
            } catch (error) {
                addConsoleLog(`Erreur lors de la configuration: ${error.message}`, 'error');
                setupBtn.disabled = false;
                setupBtn.innerHTML = '‚öôÔ∏è R√©essayer la configuration';
                showModal('Erreur de configuration', 'Une erreur est survenue lors de la configuration. V√©rifiez la console pour plus de d√©tails.');
            }
            
            updateProgress(0);
        }

        // Simulation des √©tapes de configuration
        async function setupDatabase() {
            addConsoleLog('Cr√©ation de la base de donn√©es Shivas...', 'info');
            await simulateDelay(1000);
            addConsoleLog('Tables cr√©√©es avec succ√®s', 'success');
            addConsoleLog('Donn√©es de base ins√©r√©es', 'success');
        }

        async function compileProject() {
            addConsoleLog('Ex√©cution de: gradlew clean build', 'info');
            await simulateDelay(2000);
            addConsoleLog('BUILD SUCCESSFUL', 'success');
            addConsoleLog('Artefacts g√©n√©r√©s dans build/libs/', 'info');
        }

        async function setupConfigFiles() {
            addConsoleLog('Mise √† jour de config.yaml...', 'info');
            await simulateDelay(500);
            addConsoleLog('Configuration du chemin des donn√©es...', 'info');
            await simulateDelay(500);
            addConsoleLog('Fichiers de configuration pr√™ts', 'success');
        }

        // D√©marrage du serveur
        async function startServer() {
            if (!isSetupComplete) {
                showModal('Configuration requise', 'Veuillez d\'abord effectuer la configuration automatique avant de d√©marrer le serveur.');
                return;
            }

            const startBtn = document.getElementById('startBtn');
            startBtn.disabled = true;
            startBtn.innerHTML = '‚è≥ D√©marrage...';
            
            updateServerStatus('starting');
            addConsoleLog('D√©marrage du serveur Shivas...', 'info');

            try {
                const response = await fetch('/api/start', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();
                
                if (result.success) {
                    addConsoleLog('Serveur en cours de d√©marrage...', 'info');
                    addConsoleLog(`PID du processus: ${result.pid}`, 'info');
                    
                    // V√©rifier le statut du serveur p√©riodiquement
                    let attempts = 0;
                    const maxAttempts = 30;
                    
                    const checkStatus = async () => {
                        try {
                            const statusResponse = await fetch('/api/status');
                            const status = await statusResponse.json();
                            
                            if (status.Overall === 'ONLINE') {
                                addConsoleLog('üéâ Serveur Shivas d√©marr√© avec succ√®s !', 'success');
                                addConsoleLog(`Serveur de connexion: ${status.LoginServer.Status} (port ${status.LoginServer.Port})`, 'success');
                                addConsoleLog(`Serveur de jeu: ${status.GameServer.Status} (port ${status.GameServer.Port})`, 'success');
                                addConsoleLog('En attente de connexions...', 'info');
                                
                                updateServerStatus('online');
                                showModal('Serveur d√©marr√© !', 'Votre serveur Dofus Shivas est maintenant en ligne ! Vous pouvez maintenant lancer votre client Dofus et vous connecter.');
                                return;
                            }
                            
                            attempts++;
                            if (attempts < maxAttempts) {
                                addConsoleLog(`V√©rification du statut... (${attempts}/${maxAttempts})`, 'info');
                                setTimeout(checkStatus, 2000);
                            } else {
                                throw new Error('Timeout: Le serveur n\'a pas d√©marr√© dans les temps');
                            }
                        } catch (error) {
                            addConsoleLog(`Erreur lors de la v√©rification: ${error.message}`, 'error');
                            updateServerStatus('offline');
                            startBtn.disabled = false;
                            startBtn.innerHTML = 'üöÄ D√©marrer le serveur';
                        }
                    };
                    
                    // Commencer la v√©rification apr√®s 5 secondes
                    setTimeout(checkStatus, 5000);
                    
                } else {
                    throw new Error(result.message || 'Failed to start server');
                }
                
            } catch (error) {
                addConsoleLog(`Erreur lors du d√©marrage: ${error.message}`, 'error');
                updateServerStatus('offline');
                startBtn.disabled = false;
                startBtn.innerHTML = 'üöÄ D√©marrer le serveur';
            }
        }

        // Arr√™t du serveur
        async function stopServer() {
            addConsoleLog('Arr√™t du serveur en cours...', 'warning');
            
            try {
                const response = await fetch('/api/stop', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();
                
                if (result.success) {
                    addConsoleLog('Fermeture des connexions clients...', 'info');
                    addConsoleLog('Sauvegarde des donn√©es...', 'info');
                    addConsoleLog('Serveur arr√™t√© avec succ√®s', 'warning');
                } else {
                    addConsoleLog(`Erreur lors de l'arr√™t: ${result.message}`, 'error');
                }
                
            } catch (error) {
                addConsoleLog(`Erreur lors de l'arr√™t: ${error.message}`, 'error');
            }
            
            updateServerStatus('offline');
            
            const startBtn = document.getElementById('startBtn');
            startBtn.disabled = false;
            startBtn.innerHTML = 'üöÄ D√©marrer le serveur';
        }

        // Lancement du jeu
        function playGame() {
            if (!isServerRunning) {
                showModal('Serveur requis', 'Veuillez d\'abord d√©marrer le serveur avant de jouer !');
                return;
            }

            showModal('Instructions de connexion', `
                <strong>Pour vous connecter au jeu :</strong><br><br>
                1. Lancez votre client Dofus 1.29.1<br>
                2. S√©lectionnez la configuration "localhost"<br>
                3. Connectez-vous avec n'importe quel nom d'utilisateur<br>
                4. Cr√©ez votre personnage et amusez-vous !<br><br>
                <strong>Serveur :</strong> 127.0.0.1:6789<br>
                <strong>Bon jeu ! üéÆ</strong>
            `);
            
            addConsoleLog('Instructions de connexion affich√©es', 'info');
        }

        // T√©l√©chargement du fichier de configuration
        function downloadConfig() {
            const configContent = `<?xml version="1.0" encoding="UTF-8"?>
<config>
    <delay value="500"/>
    <rdelay value="3000"/>
    <rcount value="10"/>

    <conf name="localhost">
        <connserver name="localhost:6789" ip="127.0.0.1" port="6789"/>
        <dataserver url="data/" type="local" priority="3" />
        <dataserver url="http://staticns.ankama.com/dofus/gamedata/dofus/" priority="1" />
        <dataserver url="http://gamedata.ankama-games.com/dofus/" priority="0" />
    </conf>

    <conf name="En ligne">
        <dataserver url="data/" type="local" priority="3" />
        <dataserver url="http://staticns.ankama.com/dofus/gamedata/dofus/" priority="1" />
        <dataserver url="http://gamedata.ankama-games.com/dofus/" priority="0" />
    </conf>

    <cacheasbitmap>
        <cache element="ExternalContainer/InteractionCell" value="false" />
        <cache element="ExternalContainer/Ground" value="false" />
        <cache element="ExternalContainer/Object1" value="false" />
        <cache element="ExternalContainer/Object2" value="false" />
        <cache element="ExternalContainer/Zone" value="false" />
        <cache element="ExternalContainer/Select" value="false" />
        <cache element="ExternalContainer/Grid" value="false" />
        <cache element="ExternalContainer/Pointer" value="false" />
        <cache element="GAPI/UI" value="false" />
        <cache element="GAPI/UITop" value="false" />
        <cache element="GAPI/Popup" value="false" />
        <cache element="GAPI/UIUltimate" value="false" />
        <cache element="GAPI/Cursor" value="false" />
        <cache element="mapHandler/BACKGROUND" value="false" />
        <cache element="mapHandler/Cell/Ground" value="false" />
        <cache element="mapHandler/Cell/Object1" value="false" />
        <cache element="mapHandler/Cell/Object2" value="false" />
        <cache element="mapHandler/Cell/ObjectExternal" value="false" />
        <cache element="Zone/Zone" value="true" />
        <cache element="Zone/Pointers" value="true" />
    </cacheasbitmap>
</config>`;

            const element = document.createElement('a');
            element.setAttribute('href', 'data:text/xml;charset=utf-8,' + encodeURIComponent(configContent));
            element.setAttribute('download', 'config.xml');
            element.style.display = 'none';
            document.body.appendChild(element);
            element.click();
            document.body.removeChild(element);
            
            addConsoleLog('Fichier config.xml t√©l√©charg√©', 'success');
            showModal('Configuration t√©l√©charg√©e', 'Le fichier config.xml a √©t√© t√©l√©charg√©. Placez-le dans le dossier de votre client Dofus pour vous connecter au serveur local.');
        }

        // Fonction utilitaire pour simuler des d√©lais
        function simulateDelay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // V√©rification du statut au chargement
        async function checkInitialStatus() {
            addConsoleLog('Interface Shivas charg√©e', 'info');
            addConsoleLog('V√©rification du statut du serveur...', 'info');
            
            try {
                const response = await fetch('/api/status');
                const status = await response.json();
                
                if (status.Overall === 'ONLINE') {
                    updateServerStatus('online');
                    addConsoleLog('Serveur d√©j√† en ligne d√©tect√©', 'success');
                    isSetupComplete = true;
                    document.getElementById('startBtn').disabled = false;
                    document.getElementById('setupBtn').innerHTML = '‚úÖ Configuration termin√©e';
                } else {
                    updateServerStatus('offline');
                    addConsoleLog('Serveur hors ligne', 'info');
                    addConsoleLog('Pr√™t pour la configuration', 'info');
                }
            } catch (error) {
                updateServerStatus('offline');
                addConsoleLog('Impossible de v√©rifier le statut du serveur', 'warning');
                addConsoleLog('Assurez-vous que le serveur web est d√©marr√©', 'info');
            }
        }

        // Gestion des √©v√©nements
        window.onclick = function(event) {
            const modal = document.getElementById('messageModal');
            if (event.target == modal) {
                closeModal();
            }
        }

        // Initialisation
        window.onload = function() {
            checkInitialStatus();
        };
    </script>
</body>
</html>